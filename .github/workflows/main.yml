name: CI/CD multistage pipeline
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # buid stage
 build:
  runs-on: ubuntu-latest
  environment: build
  outputs:
    artifact_path: ${{ steps.upload-artifact.outputs.artifact-path }}
  steps:
   - name: checkout code
     uses: actions/checkout@v4
   - name: Set up Node.js
     uses: actions/setup-node@v4
     with: 
       node-version: '18'
   - name: Install dependencies
     run: npm ci
   - name: Build Project
     run: npm run build
   - name: Upload Build Artifact
     id: upload-artifct
     uses: actions/upload-artifact@v4
     with:
       name: app-build
       path: ./dist
       retention-days: 10
       
 # Test stage
 test:
  needs: build
  runs-on: ubuntu-latest
  startegy:
    fail-fast: false
      matrix:
      node-version: {16. 18, 20]
      os: [ubuntu-latest, windows-latest]
    name: Test (Node ${{matrix.node-version }} on ${{ matrix.os }})
  
  outputs:
    artifact_path: ${{ steps.upload-artifact.outputs.artifact-path }}
  steps:
   - name: checkout code
     uses: actions/checkout@v4
   - name: Set up Node.js
     uses: actions/setup-node@v4
     with: 
       node-version: ${{ matrix.node-version }}
   - name: Install dependencies
     run: npm ci
   - name: run test
     run: npm test
